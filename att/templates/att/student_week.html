{% extends "att/base.html" %}

{% block title %}Week View{% endblock %}

{% block content %}

    <section class="section is-flex is-flex-direction-column" style="height: 95vh;">
        <div class="box">
            <div class="field">
                <div class="control has-icons-left">
                    <button id="student-button" class="button is-fullwidth is-primary">
                        {{ student.last_name }}, {{ student.first_name }}
                        <span id="search-icon" class="icon is-left">
                            <i class="fa-solid fa-search"></i>
                        </span>
                    </button>
                </div>
                <div id="search-control" class="control has-icons-left invisible">
                    <input id="search-input" type="search" class="input is-info"
                           placeholder="Search another student">
                    <span class="icon is-left">
                        <i class="fa-solid fa-search" aria-hidden="true"></i>
                    </span>
                </div>
                <div class="menu">
                    <ul id="results" class="menu-list">
                    </ul>
                </div>
            </div>

            <div class="field has-addons">
                <div class="control">
                    <a class="button is-warning is-inverted is-fullwidth" href="{% url 'att:student-week' student_id=student.id year=previous_week.year month=previous_week.month day=previous_week.day %}">
                        <span class="icon"><i class="fa-solid fa-circle-arrow-left"></i></span>
                    </a>
                </div>
                <div class="control" style="width: 100%;">
                    <div class="date-picker-wrapper">
                        <button id="open-date-picker" class="button is-fullwidth is-warning">
                            <span class="panel-icon"><i class="fa-solid fa-calendar" aria-hidden="true"></i></span>
                            <span class="is-hidden-tablet">{{ start_of_week|date:'M j' }} -- {{ end_of_week|date:'M j' }}</span>
                            <span class="is-hidden-mobile">{{ start_of_week|date:'F j' }} -- {{ end_of_week|date:'F j' }}</span>
                        </button>
                        <input type="date" id="hidden-date-picker" class="invisible"\>
                    </div>
                </div>
                <div class="control">
                    <a class="button is-fullwidth is-inverted is-warning" href="{% url 'att:student-week' student_id=student.id year=next_week.year month=next_week.month day=next_week.day %}">
                        <span class="icon"><i class="fa-solid fa-circle-arrow-right"></i></span>
                    </a>
                </div>
            </div>
        </div>

        <div class="columns is-1-mobile is-1-desktop attendance-scroll-container">
            {% for day, records in records_by_day %}
                <div class="column">
                    <div class="weeklyblock">
                        <a class="button is-fullwidth is-warning" href="{% url 'att:student-on-day' student_id=student.id year=day.year month=day.month day=day.day %}">{{ day|date:"D" }}<br>{{ day|date:"M j" }}</a>
                    </div>
                    {% for period, record in records %}
                        <div class="weeklyblock">
                            {% if record %}
                                <button id="lesson-{{ record.lesson.id }}"
                                        class="attendance-button button is-fullwidth"
                                        data-period-id="{{ record.lesson.period.id }}"
                                        data-lesson-id="{{ record.lesson.id }}"
                                        data-student-id="{{ student.id }}"
                                        data-attendance-status="{{ record.status }}">
                                    <span class="icon">
                                        <i id="icon-{{ record.lesson.id }}" class="fa-solid"></i>
                                    </span>
                                    <span>{{ period.start_time|date:"H:i" }} {{ record.lesson.course.shorten_name }}</span>
                                </button>
                            {% else %}
                                <a class="button is-fullwidth is-hidden-mobile" disabled>-</a>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>

        <p><a href="{% url 'att:lessons-today' %}">ðŸ“… Back to Today</a></p>

    </section>

    <script type="text/javascript">
     document.addEventListener("DOMContentLoaded", function () {

         const studentButton = document.getElementById("student-button");
         const resultsBlock = document.getElementById("results");
         const searchInput = document.getElementById("search-input");
         const searchControl = document.getElementById("search-control");
         const searchIcon = document.getElementById("search-icon");
         studentButton.addEventListener("click", () => {
             searchIcon.classList.toggle("invisible");
             searchControl.classList.toggle("invisible");
             searchInput.focus();
         });
         searchInput.addEventListener("input", () => {
             if (searchInput.value != "") {
                 fetch("{% url 'att:do-search-students' %}", {
                     method: "POST",
                     headers: {
                         "Content-type": "application/json",
                         "X-CSRFToken": "{{ csrf_token }}"
                     },
                     body: JSON.stringify({
                         searchstr: searchInput.value
                     })
                 }).then(response => {
                     if (!response.ok) {
                         alert("Error searching students");
                     }
                     return response.json();
                 }).then(data => {
                     const results = data.search_results;
                     resultsBlock.innerHTML = "";
                     results.forEach(result => {
                         resultsBlock.innerHTML = resultsBlock.innerHTML + `<li data-student-id="${result.student_id}"><a href="/att/student-week/${result.student_id}/{{ start_of_week.year }}/{{ start_of_week.month }}/{{ start_of_week.day }}/">` + result.name + "</a></li>";
                     });
                     resultsBlock.children[0].children[0].classList.add("is-active");
                 }).catch(error => {
                     alert("Error searching students: " + error);
                 });
             }
             else {
                 resultsBlock.innerHTML = "";
             }
         });
         searchInput.addEventListener("change", () => {
             const firstResult = resultsBlock.children[0];
             const url = `/att/student-week/${firstResult.dataset.studentId}/{{ start_of_week.year }}/{{ start_of_week.month }}/{{ start_of_week.day }}/`;
             window.location.href = url;
         });

         const openBtn = document.getElementById("open-date-picker");
         const hiddenPicker = document.getElementById("hidden-date-picker");
         openBtn.addEventListener("click", function () {
             hiddenPicker.classList.toggle("invisible");
         });
         hiddenPicker.addEventListener("change", function () {
             hiddenPicker.classList.add("invisible");
             const selectedDate = new Date(this.value);
             console.log(selectedDate);
             const year = selectedDate.getFullYear();
             const month = selectedDate.getMonth();
             const day = selectedDate.getDate();
             const url = `/att/student-week/{{ student.id }}/${year}/${parseInt(month)+1}/${day}/`;
             window.location.href = url;
         });

         const buttonClass = {
             "absent": "is-danger",
             "late": "is-warning",
             "present": "is-success"
         };
         const iconClass = {
             "unregistered": "fa-circle-question",
             "present": "fa-check",
             "absent": "fa-warning",
             "late": "fa-clock"
         };
         function addStatusIcon(attStatus, indi) {
             indi.className = "";
             indi.classList.add("fa-solid");
             indi.classList.add(iconClass[attStatus]);
         }
         document.querySelectorAll(".attendance-button").forEach(button => {
             button.classList.add(buttonClass[button.dataset.attendanceStatus]);
             const lessonId = button.dataset.lessonId;
             const periodId = button.dataset.periodId;
             const studentId = {{ student.id }};
             const indicator = document.getElementById("icon-" + lessonId);
             const lessonButton = document.getElementById("lesson-" + lessonId);
             const attendanceStatus = button.dataset.attendanceStatus;
             addStatusIcon(attendanceStatus, indicator);
             button.addEventListener("click", function () {
                 fetch("{% url 'att:mark-attendance' %}", {
                     method: "POST",
                     headers: {
                         "Content-type": "application/json",
                         "X-CSRFToken": "{{ csrf_token }}"
                     },
                     body: JSON.stringify({
                         studentId: studentId,
                         lessonId: lessonId,
                     })
                 }).then(response => {
                     if (!response.ok) {
                         alert("Error saving attendance");
                     }
                     return response.json();
                 }).then(data => {
                     this.classList.remove(buttonClass[this.dataset.attendanceStatus]);
                     this.classList.add(buttonClass[data.attendanceStatus]);
                     this.dataset.attendanceStatus = data.attendanceStatus;
                     addStatusIcon(data.attendanceStatus, indicator);
                 }).catch(error => {
                     alert("Error saving attendance: " + error);
                 });
             });
         });

     });
    </script>
{% endblock %}
