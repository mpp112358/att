{% extends "att/base.html" %}

{% block title %}Student's Lessons on Day{% endblock %}

{% block content %}
    <section id="lessons-list" class="section is-flex is-flex-direction-column">

        <div class="block">
        <div id="lessons-list-header">
            <div class="columns">
                <div class="column">
                    <div class="control is-fullwidth has-icons-left">
                        <button id="student-button" class="button is-primary is-fullwidth is-size-6-mobile is-size-4-tablet">
                            {{ student.last_name }}, {{ student.first_name }}
                            <span id="search-icon" class="icon is-left">
                                <i class="fa-solid fa-search"></i>
                            </span>
                        </button>
                    </div>
                    <div id="search-control" class="control has-icons-left invisible">
                        <input id="search-input" type="search" class="input is-info"
                               placeholder="Search another student">
                        <span class="icon is-left">
                            <i class="fa-solid fa-search" aria-hidden="true"></i>
                        </span>
                    </div>
                    <div class="menu">
                        <ul id="results" class="menu-list">
                        </ul>
                    </div>
                </div>
            </div>
            <div class="columns is-mobile is-1-mobile is-2-tablet is-3-desktop">
                <div class="column is-half">
                    <a class="button is-fullwidth" href="{% url 'att:student-on-day' student_id=student.id year=today.year month=today.month day=today.day %}">
                        ðŸ“… Today
                    </a>
                </div>
                <div class="column is-half">
                    <a class="button is-fullwidth" href="{% url 'att:student-week' student_id=student.id year=day.year month=day.month day=day.day %}">
                        Week
                    </a>
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <div class="field has-addons">
                    <div class="control">
                        <a class="button is-fullwidth is-warning is-inverted" href="{% url 'att:student-on-day' student_id=student.id year=previous_day.year month=previous_day.month day=previous_day.day %}">
                            <span class="icon"><i class="fa-solid fa-circle-arrow-left"></i></span>
                        </a>
                    </div>
                    <div class="control" style="width: 100%;">
                        <div class="date-picker-wrapper">
                            <button id="open-date-picker" class="button is-fullwidth is-warning">
                                {{ day|date:'D, j M Y' }}
                            </button>
                            <input type="date" id="hidden-date-picker" class="invisible">
                        </div>
                    </div>
                    <div class="control">
                        <a class="button is-fullwidth is-warning is-inverted" href="{% url 'att:student-on-day' student_id=student.id year=next_day.year month=next_day.month day=next_day.day %}">
                            <span class="icon"><i class="fa-solid fa-circle-arrow-right"></i></span>
                        </a>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <div id="lessons-list-container" class="attendance-scroll-container" style="max-height: 65vh;">
            {% if attendance_records %}
                {% for record in attendance_records %}
                    <div class="columns is-mobile is-1-mobile lesson-row" style="margin-bottom: 2px;">
                        <div class="column is-narrow">
                            <button class="attendance-button button is-large is-size-6-mobile is-size-4-tablet is-fullwidth"
                                    data-period-id="{{ record.lesson.period.id }}"
                                    data-lesson-id="{{ record.lesson.id }}"
                                    data-attendance_record-status="{{ record.status }}">
                                <span class="icon is-size-6-mobile is-size-4-tablet">
                                    <i id="icon-{{ record.lesson.period.id }}" class="fa-solid"></i>
                                </span>
                                <span>{{ record.lesson.period.start_time|date:"H:i" }}</span>
                            </button>
                        </div>
                        <div class="column">
                            <a  id="lesson-{{ record.lesson.period.id }}" href="{% url 'att:lesson-detail' record.lesson.id %}"
                                class="attendance-lesson-button button is-large is-size-6-mobile is-size-4-tablet is-fullwidth is-justify-content-flex-start">
                                <span class="is-hidden-mobile">{{ record.lesson.course }}</span>
                                <span class="is-hidden-tablet">{{ record.lesson.course.shorten_name }}</span>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No lessons today.</p>
            {% endif %}
        </div>

    </section>

    <script type="text/javascript">
     document.addEventListener("DOMContentLoaded", function () {

         const studentButton = document.getElementById("student-button");
         const resultsBlock = document.getElementById("results");
         const searchInput = document.getElementById("search-input");
         const searchControl = document.getElementById("search-control");
         const searchIcon = document.getElementById("search-icon");
         studentButton.addEventListener("click", () => {
             searchIcon.classList.toggle("invisible");
             searchControl.classList.toggle("invisible");
             searchInput.focus();
         });
         searchInput.addEventListener("input", () => {
             if (searchInput.value != "") {
                 fetch("{% url 'att:do-search-students' %}", {
                     method: "POST",
                     headers: {
                         "Content-type": "application/json",
                         "X-CSRFToken": "{{ csrf_token }}"
                     },
                     body: JSON.stringify({
                         searchstr: searchInput.value
                     })
                 }).then(response => {
                     if (!response.ok) {
                         alert("Error searching students");
                     }
                     return response.json();
                 }).then(data => {
                     const results = data.search_results;
                     resultsBlock.innerHTML = "";
                     results.forEach(result => {
                         resultsBlock.innerHTML = resultsBlock.innerHTML + `<li data-student-id="${result.student_id}"><a href="/att/student/${result.student_id}/{{ day.year }}/{{ day.month }}/{{ day.day }}/">` + result.name + "</a></li>";
                     });
                     resultsBlock.children[0].children[0].classList.add("is-active");
                 }).catch(error => {
                     alert("Error searching students: " + error);
                 });
             }
             else {
                 resultsBlock.innerHTML = "";
             }
         });
         searchInput.addEventListener("change", () => {
             const firstResult = resultsBlock.children[0];
             const url = `/att/student/${firstResult.dataset.studentId}/{{ day.year }}/{{ day.month }}/{{ day.day }}/`;
             window.location.href = url;
         });

         const openBtn = document.getElementById("open-date-picker");
         const hiddenPicker = document.getElementById("hidden-date-picker");
         openBtn.addEventListener("click", function () {
             hiddenPicker.classList.toggle("invisible");
         });
         hiddenPicker.addEventListener("change", function () {
             hiddenPicker.classList.add("invisible");
             const selectedDate = new Date(this.value);
             const year = selectedDate.getFullYear();
             const month = selectedDate.getMonth() + 1;
             const day = selectedDate.getDate();
             const url = `/att/student/{{ student.id }}/${year}/${month}/${parseInt(day)}/`;
             window.location.href = url;
         });

         const buttonClass = {
             "absent": "is-danger",
             "late": "is-warning",
             "present": "is-success"
         };
         const iconClass = {
             "unregistered": "fa-circle-question",
             "present": "fa-check",
             "absent": "fa-warning",
             "late": "fa-clock"
         }
         function addStatusIcon(attStatus, indi) {
             indi.className = "";
             indi.classList.add("fa-solid");
             indi.classList.add(iconClass[attStatus]);
         }
         document.querySelectorAll(".attendance-button").forEach(button => {
             button.classList.add(buttonClass[button.dataset.attendance_recordStatus]);
             const lessonId = button.dataset.lessonId;
             const periodId = button.dataset.periodId;
             const studentId = {{ student.id }};
             const indicator = document.getElementById("icon-" + periodId);
             const lessonButton = document.getElementById("lesson-" + periodId);
             const attendanceStatus = button.dataset.attendance_recordStatus;
             addStatusIcon(attendanceStatus, indicator);
             lessonButton.classList.add(buttonClass[button.dataset.attendance_recordStatus]);
             button.addEventListener("click", function () {
                 fetch("{% url 'att:mark-attendance' %}", {
                     method: "POST",
                     headers: {
                         "Content-type": "application/json",
                         "X-CSRFToken": "{{ csrf_token }}"
                     },
                     body: JSON.stringify({
                         studentId: studentId,
                         lessonId: lessonId,
                     })
                 }).then(response => {
                     if (!response.ok) {
                         alert("Error saving attendance");
                     }
                     return response.json();
                 }).then(data => {
                     this.classList.remove(buttonClass[this.dataset.attendance_recordStatus]);
                     this.classList.add(buttonClass[data.attendanceStatus]);
                     lessonButton.classList.remove(buttonClass[this.dataset.attendance_recordStatus]);
                     lessonButton.classList.add(buttonClass[data.attendanceStatus]);
                     this.dataset.attendance_recordStatus = data.attendanceStatus;
                     // indicator.textContent = ": " + data.attendanceStatus;
                     addStatusIcon(data.attendanceStatus, indicator);
                     // if (data.minutesLate) {
                     //     indicator.textContent = indicator.textContent + " (" + data.minutesLate + " min)";
                     // }
                 }).catch(error => {
                     alert("Error saving attendance: " + error);
                 });
             });
         });

     });
      </script>
{% endblock %}
